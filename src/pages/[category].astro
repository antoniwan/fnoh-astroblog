---
import BaseLayout from "../layouts/BaseLayout.astro";

import PostsGrid from "../components/ui/PostsGrid.astro";
import { SITE_TITLE } from "../consts";
import { getCollection } from "astro:content";
import { getCategoryBySlug } from "../utils/categories";

export async function getStaticPaths() {
  const posts = await getCollection("writings");

  // Get unique categories from posts using references
  const categories = [
    ...new Set(posts.map((post) => post.data.category?.id).filter(Boolean)),
  ];

  return categories.map((category) => ({
    params: { category },
    props: { category },
  }));
}

const { category } = Astro.props;
const posts = await getCollection("writings");
const categoryPosts = posts
  .filter((post) => post.data.category?.id === category)
  .sort(
    (a, b) =>
      new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
  );

// Ensure category is defined
if (!category) {
  throw new Error("Category parameter is required");
}

// Get category data from collection
const categoryData = await getCategoryBySlug(category);
const pageTitle = categoryData?.title || category;
const categoryDescription =
  categoryData?.description || `Posts in the ${category} category`;
const categoryEmoji = categoryData?.emoji || "üìÅ";
---

<BaseLayout
  title={`${pageTitle} - ${SITE_TITLE}`}
  description={categoryDescription}
  type="website"
  section={pageTitle}
>
  <div class="w-full">
    <div class="text-center mb-12 py-8 border-b border-gray-200">
      <div class="mb-4">
        <span class="text-4xl mb-4 block">{categoryEmoji}</span>
        <h1 class="text-3xl font-bold text-gray-900 mb-4">{pageTitle}</h1>
      </div>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        {categoryDescription}
        <strong class="text-gray-900"
          >{categoryPosts.length} writing{
            categoryPosts.length !== 1 ? "s" : ""
          }</strong
        >.
      </p>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {
        categoryPosts.length > 0 ? (
          <PostsGrid posts={categoryPosts} />
        ) : (
          <div class="text-center py-12">
            <p class="text-gray-600 mb-4">No posts found in this category.</p>
            <a href="/" class="text-blue-600 hover:text-blue-800 transition-colors duration-200">
              ‚Üê Back to Home
            </a>
          </div>
        )
      }
    </main>
  </div>
</BaseLayout>
