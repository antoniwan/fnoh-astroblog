---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

import PostCard from '../../components/ui/PostCard.astro';
import { SITE_TITLE } from '../../consts';
import { getCategoriesWithPosts } from '../../utils/categories';

// Get all posts and sort by publication date
const allPosts = await getCollection('writings');
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// Get categories that have posts
const categoriesWithPosts = await getCategoriesWithPosts();

// Pagination: Show only first 12 posts initially for better performance
const POSTS_PER_PAGE = 12;
const initialPosts = sortedPosts.slice(0, POSTS_PER_PAGE);
const totalPosts = sortedPosts.length;
---

<BaseLayout 
	title={`Writings - ${SITE_TITLE}`} 
	description="Explore thoughtful reflections on humanity, personal growth, and the human condition through our collection of writings."
	type="website"
	section="Writings"
>
	<div class="container-full">
		<header class="category-header">
			<div class="category-info">
				<span class="category-emoji">‚úçÔ∏è</span>
				<h1 class="category-title">Writings</h1>
			</div>
			<p class="category-description">Thoughtful explorations of what it means to be human <strong>{totalPosts} writing{totalPosts !== 1 ? 's' : ''}</strong>.</p>
		</header>

		{/* Category Filter Section */}
		{categoriesWithPosts.length > 0 && (
			<section class="category-filter-section">
				<h2 class="filter-title">Browse by Category</h2>
				<div class="category-filters">
					<a href="/writings" class="category-filter active" data-astro-reload>
						<span class="filter-emoji">üìö</span>
						<span class="filter-name">All Posts</span>
						<span class="filter-count">{totalPosts}</span>
					</a>
					{categoriesWithPosts.map(category => {
						const categoryPosts = allPosts.filter(post => 
							post.data.category?.id === category.slug
						);
						return (
							<a href={`/${category.slug}`} class="category-filter" data-astro-reload>
								<span class="filter-emoji">{category.emoji}</span>
								<span class="filter-name">{category.title}</span>
								<span class="filter-count">{categoryPosts.length}</span>
							</a>
						);
					})}
				</div>
			</section>
		)}

		<main class="category-content">
		{initialPosts.length > 0 ? (
			<div class="posts-grid">
				{initialPosts.map((post) => (
					<PostCard post={post} />
				))}
			</div>
		) : (
			<div class="no-posts">
				<div class="empty-field-notes">
					<span class="empty-emoji">üìù</span>
					<h3 class="empty-title">Field Notes Empty</h3>
					<p class="empty-description">The observation journal is currently blank. Perhaps the pseudothropologist is still in the field, gathering fresh insights to document.</p>
					<a href="/" class="back-link">‚Üê Return to Base Camp</a>
				</div>
			</div>
		)}
		
		{totalPosts > POSTS_PER_PAGE && (
			<div class="pagination">
				<button id="load-more" class="load-more-btn">
					Load More Writings ({totalPosts - initialPosts.length} remaining)
				</button>
			</div>
		)}
			</main>
	</div>
</BaseLayout>

<script>
	// Lazy load more posts for better performance
	const loadMoreBtn = document.getElementById('load-more') as HTMLButtonElement;
	const postsGrid = document.querySelector('.posts-grid');
	
	if (loadMoreBtn && postsGrid) {
		loadMoreBtn.addEventListener('click', async () => {
			loadMoreBtn.textContent = 'Loading...';
			loadMoreBtn.disabled = true;
			
			// Simulate loading delay for better UX
			await new Promise(resolve => setTimeout(resolve, 300));
			
			// In a real implementation, you'd fetch more posts from an API
			// For now, we'll just hide the button
			loadMoreBtn.style.display = 'none';
			
			// You could implement actual pagination here
			// const response = await fetch('/api/posts?page=2');
			// const morePosts = await response.json();
			// Render more posts...
		});
	}
</script>

<style>
	.category-header {
		text-align: center;
		margin-bottom: var(--spacing-2xl);
		padding: var(--spacing-xl) 0;
		border-bottom: 1px solid var(--color-border-light);
		position: relative;
	}

	.category-header::after {
		content: '';
		position: absolute;
		bottom: -1px;
		left: 50%;
		transform: translateX(-50%);
		width: 60%;
		height: 2px;
		background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
		border-radius: var(--border-radius-sm);
	}

	.category-info {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: var(--spacing);
		margin-bottom: var(--spacing);
	}

	.category-emoji {
		font-size: var(--font-size-3xl);
	}

	.category-title {
		font-family: var(--font-family-heading);
		font-size: var(--font-size-3xl);
		font-weight: var(--font-weight-bold);
		margin: 0;
		color: var(--color-heading);
		line-height: var(--line-height-tight);
		letter-spacing: var(--letter-spacing-tight);
	}

	.category-description {
		font-size: var(--font-size-lg);
		color: var(--color-text-light);
		max-width: 600px;
		margin: 0 auto var(--spacing);
		line-height: var(--line-height-relaxed);
		text-align: justify;
	}

	/* Category Filter Styles */
	.category-filter-section {
		margin-bottom: var(--spacing-2xl);
		padding: var(--spacing-xl) 0;
		border-bottom: 1px solid var(--color-border-light);
	}

	.filter-title {
		font-family: var(--font-family-heading);
		font-size: var(--font-size-xl);
		font-weight: var(--font-weight-semibold);
		color: var(--color-heading);
		margin: 0 0 var(--spacing-lg) 0;
		text-align: center;
	}

	.category-filters {
		display: flex;
		flex-wrap: wrap;
		gap: var(--spacing-md);
		justify-content: center;
		max-width: 800px;
		margin: 0 auto;
	}

	.category-filter {
		display: flex;
		align-items: center;
		gap: var(--spacing-sm);
		padding: var(--spacing-sm) var(--spacing-md);
		border: 2px solid var(--color-border-light);
		border-radius: var(--border-radius-lg);
		text-decoration: none;
		color: var(--color-text);
		background: var(--color-bg);
		transition: all var(--transition-fast);
		font-weight: var(--font-weight-medium);
		min-width: 120px;
		justify-content: center;
	}

	.category-filter:hover {
		border-color: var(--color-primary);
		background: var(--color-bg-secondary);
		transform: translateY(-2px);
		box-shadow: var(--shadow-sm);
	}

	.category-filter.active {
		border-color: var(--color-primary);
		background: var(--color-primary);
		color: white;
	}

	.filter-emoji {
		font-size: var(--font-size-lg);
	}

	.filter-name {
		font-size: var(--font-size-sm);
		text-transform: uppercase;
		letter-spacing: var(--letter-spacing-wider);
	}

	.filter-count {
		background: var(--color-bg-secondary);
		color: var(--color-text-light);
		padding: var(--spacing-xs) var(--spacing-sm);
		border-radius: var(--border-radius-full);
		font-size: var(--font-size-xs);
		font-weight: var(--font-weight-semibold);
		min-width: 24px;
		text-align: center;
	}

	.category-filter.active .filter-count {
		background: rgba(255, 255, 255, 0.2);
		color: white;
	}

	.category-content {
		width: 100%;
	}

	.posts-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: var(--spacing-xl);
		width: 100%;
	}

	.no-posts {
		text-align: center;
		padding: var(--spacing-2xl);
	}

	.empty-field-notes {
		max-width: 500px;
		margin: 0 auto;
	}

	.empty-emoji {
		font-size: var(--font-size-4xl);
		display: block;
		margin-bottom: var(--spacing-lg);
	}

	.empty-title {
		font-family: var(--font-family-heading);
		font-size: var(--font-size-xl);
		font-weight: var(--font-weight-semibold);
		color: var(--color-heading);
		margin: 0 0 var(--spacing-md) 0;
		line-height: var(--line-height-tight);
		letter-spacing: var(--letter-spacing-tight);
	}

	.empty-description {
		font-size: var(--font-size-lg);
		color: var(--color-text-light);
		margin: 0 0 var(--spacing-lg) 0;
		line-height: var(--line-height-relaxed);
		font-style: italic;
		font-family: var(--font-family-serif);
		text-align: justify;
	}

	.no-posts p {
		font-size: var(--font-size-lg);
		color: var(--color-text-light);
		margin-bottom: var(--spacing-lg);
	}

	.back-link {
		display: inline-block;
		color: var(--color-primary);
		text-decoration: none;
		font-weight: var(--font-weight-medium);
		transition: all var(--transition-fast);
		padding: var(--spacing-sm) var(--spacing-md);
		border-radius: var(--border-radius-sm);
		background-color: var(--color-bg-secondary);
		border: 1px solid var(--color-border-light);
	}

	.back-link:hover {
		color: var(--color-primary-dark);
		background-color: var(--color-hover-bg);
		transform: translateX(-2px);
		box-shadow: var(--shadow-sm);
	}

	.pagination {
		text-align: center;
		margin-top: var(--spacing-2xl);
	}
	
	.load-more-btn {
		background-color: var(--color-primary);
		color: white;
		border: none;
		padding: var(--spacing) var(--spacing-xl);
		border-radius: var(--border-radius-md);
		font-size: var(--font-size-base);
		font-weight: var(--font-weight-medium);
		cursor: pointer;
		transition: all var(--transition-fast);
		font-family: var(--font-family);
		letter-spacing: var(--letter-spacing-normal);
		position: relative;
		overflow: hidden;
	}
	
	.load-more-btn::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
		opacity: 0;
		transition: opacity var(--transition-fast);
		z-index: 0;
	}
	
	.load-more-btn:hover:not(:disabled) {
		background-color: var(--color-primary-dark);
		transform: translateY(-2px);
		box-shadow: var(--shadow-md);
	}
	
	.load-more-btn:hover:not(:disabled)::before {
		opacity: 0.1;
	}
	
	.load-more-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	@media (max-width: 768px) {
		.category-header {
			padding: var(--spacing-lg) 0;
			margin-bottom: var(--spacing-xl);
		}

		.category-title {
			font-size: var(--font-size-2xl);
		}

		.category-description {
			font-size: var(--font-size-base);
		}

		.category-filter-section {
			padding: var(--spacing-lg) 0;
			margin-bottom: var(--spacing-xl);
		}

		.filter-title {
			font-size: var(--font-size-lg);
		}

		.category-filters {
			gap: var(--spacing-sm);
		}

		.category-filter {
			min-width: 100px;
			padding: var(--spacing-xs) var(--spacing-sm);
		}

		.filter-name {
			font-size: var(--font-size-xs);
		}

		.posts-grid {
			grid-template-columns: 1fr;
			gap: var(--spacing-lg);
		}
	}

	@media (max-width: 480px) {
		.category-filters {
			flex-direction: column;
			align-items: center;
		}

		.category-filter {
			width: 100%;
			max-width: 200px;
			justify-content: space-between;
		}
	}
</style>
