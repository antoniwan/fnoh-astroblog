---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

import PostsGrid from "../../components/ui/PostsGrid.astro";
import { SITE_TITLE } from "../../consts";
import { getCategoriesWithPosts } from "../../utils/categories";

// Get all posts and sort by publication date
const allPosts = await getCollection("writings");
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
);

// Get categories that have posts
const categoriesWithPosts = await getCategoriesWithPosts();

// Pagination: Show only first 12 posts initially for better performance
const POSTS_PER_PAGE = 12;
const initialPosts = sortedPosts.slice(0, POSTS_PER_PAGE);
const totalPosts = sortedPosts.length;
---

<BaseLayout
  title={`Writings - ${SITE_TITLE}`}
  description="Explore thoughtful reflections on humanity, personal growth, and the human condition through our collection of writings."
  type="website"
  section="Writings"
>
  <div class="w-full">
    <div class="text-center mb-12 py-8 border-b border-gray-200">
      <div class="mb-4">
        <span class="text-4xl mb-4 block">‚úçÔ∏è</span>
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Writings</h1>
      </div>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Thoughtful explorations of what it means to be human <strong
          >{totalPosts} writing{totalPosts !== 1 ? "s" : ""}</strong
        >.
      </p>
    </div>

    {/* Category Filter Section */}
    {
      categoriesWithPosts.length > 0 && (
        <section class="mb-12">
          <h2 class="text-xl font-semibold text-gray-900 mb-6 text-center">
            Browse by Category
          </h2>
          <div class="flex flex-wrap justify-center gap-4 max-w-4xl mx-auto">
            <a
              href="/writings"
              class="flex items-center gap-3 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors duration-200"
              data-astro-reload
            >
              <span class="text-lg">üìö</span>
              <span>All Posts</span>
              <span class="bg-blue-500 px-2 py-1 rounded text-sm">
                {totalPosts}
              </span>
            </a>
            {categoriesWithPosts.map((category) => {
              const categoryPosts = allPosts.filter(
                (post) => post.data.category?.id === category.slug,
              );
              return (
                <a
                  href={`/${category.slug}`}
                  class="flex items-center gap-3 px-4 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors duration-200"
                  data-astro-reload
                >
                  <span class="text-lg">{category.emoji}</span>
                  <span>{category.title}</span>
                  <span class="bg-gray-200 px-2 py-1 rounded text-sm">
                    {categoryPosts.length}
                  </span>
                </a>
              );
            })}
          </div>
        </section>
      )
    }

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {
        initialPosts.length > 0 ? (
          <PostsGrid
            posts={initialPosts}
            showLoadMore={totalPosts > POSTS_PER_PAGE}
            totalPosts={totalPosts}
            initialPostsCount={POSTS_PER_PAGE}
          />
        ) : (
          <div class="text-center py-16">
            <div class="max-w-md mx-auto">
              <span class="text-6xl block mb-4">üìù</span>
              <h3 class="text-2xl font-bold text-gray-900 mb-4">
                Field Notes Empty
              </h3>
              <p class="text-gray-600 mb-6">
                The observation journal is currently blank. Perhaps the
                pseudothropologist is still in the field, gathering fresh
                insights to document.
              </p>
              <a
                href="/"
                class="text-blue-600 hover:text-blue-800 transition-colors duration-200"
              >
                ‚Üê Return to Base Camp
              </a>
            </div>
          </div>
        )
      }
    </main>
  </div>
</BaseLayout>
